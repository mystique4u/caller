name: Restore from Storage Box Backup

on:
  workflow_dispatch:
    inputs:
      backup_date:
        description: 'Backup date to restore (format: YYYYMMDD_HHMMSS or "latest")'
        required: true
        default: 'latest'
      restore_components:
        description: 'What to restore'
        required: true
        type: choice
        options:
          - 'all'
          - 'database-only'
          - 'matrix-only'
          - 'jitsi-only'
          - 'wireguard-only'
          - 'traefik-only'
        default: 'all'
      confirm:
        description: 'Type "RESTORE" to confirm (will overwrite current data!)'
        required: true

jobs:
  restore:
    name: Restore from Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "RESTORE" ]; then
            echo "‚ùå Confirmation failed. You must type 'RESTORE' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation verified"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP || '46.224.49.30' }} >> ~/.ssh/known_hosts

      - name: List available backups
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP || '46.224.49.30' }} << 'EOF'
          echo "üìã Available backups on Storage Box:"
          lftp -u "${{ secrets.STORAGEBOX_USER }},${{ secrets.STORAGEBOX_PASSWORD }}" -p 23 sftp://${{ secrets.STORAGEBOX_HOST }} << LFTP_LIST
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          cd /home/backups/hosts/caller
          cls -l --sort=date | head -20
          bye
          LFTP_LIST
          EOF

      - name: Download and restore backup
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP || '46.224.49.30' }} << 'EOF'
          set -e
          
          BACKUP_DATE="${{ github.event.inputs.backup_date }}"
          RESTORE_COMPONENTS="${{ github.event.inputs.restore_components }}"
          STORAGEBOX_HOST="${{ secrets.STORAGEBOX_HOST }}"
          STORAGEBOX_USER="${{ secrets.STORAGEBOX_USER }}"
          STORAGEBOX_PASSWORD="${{ secrets.STORAGEBOX_PASSWORD }}"
          STORAGEBOX_PORT="23"
          REMOTE_BASE="/home/backups/hosts/caller"
          RESTORE_DIR="/tmp/restore-$(date +%Y%m%d_%H%M%S)"
          
          echo "========================================"
          echo "üîÑ Starting Restore Operation"
          echo "Backup Date: ${BACKUP_DATE}"
          echo "Components: ${RESTORE_COMPONENTS}"
          echo "Started at: $(date)"
          echo "========================================"
          
          mkdir -p "${RESTORE_DIR}"
          cd "${RESTORE_DIR}"
          
          # Download backups from Storage Box
          echo "‚¨áÔ∏è  Downloading backup files..."
          if [ "$BACKUP_DATE" = "latest" ]; then
            echo "üì¶ Finding latest backup..."
            lftp -u "${STORAGEBOX_USER},${STORAGEBOX_PASSWORD}" -p ${STORAGEBOX_PORT} sftp://${STORAGEBOX_HOST} << LFTP_DOWNLOAD
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          cd ${REMOTE_BASE}
          mget *$(ls -t *.tar.gz *.sql.gz 2>/dev/null | head -1 | grep -oP '\d{8}_\d{6}')*
          bye
          LFTP_DOWNLOAD
          else
            lftp -u "${STORAGEBOX_USER},${STORAGEBOX_PASSWORD}" -p ${STORAGEBOX_PORT} sftp://${STORAGEBOX_HOST} << LFTP_DOWNLOAD
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          cd ${REMOTE_BASE}
          mget *${BACKUP_DATE}*
          bye
          LFTP_DOWNLOAD
          fi
          
          echo "üì• Downloaded files:"
          ls -lh
          
          # Stop services before restore
          echo "‚è∏Ô∏è  Stopping services..."
          cd /opt/services
          docker compose stop
          
          # Restore based on selection
          if [ "$RESTORE_COMPONENTS" = "all" ] || [ "$RESTORE_COMPONENTS" = "database-only" ]; then
            echo "üóÑÔ∏è  Restoring PostgreSQL database..."
            DB_FILE=$(ls ${RESTORE_DIR}/matrix-postgres-*.sql.gz | head -1)
            if [ -f "$DB_FILE" ]; then
              docker compose start matrix-postgres
              sleep 5
              gunzip -c "$DB_FILE" | docker exec -i matrix-postgres psql -U synapse -d synapse
              echo "‚úÖ Database restored"
            else
              echo "‚ö†Ô∏è  No database backup found"
            fi
          fi
          
          if [ "$RESTORE_COMPONENTS" = "all" ] || [ "$RESTORE_COMPONENTS" = "matrix-only" ]; then
            echo "üí¨ Restoring Matrix Synapse data..."
            MATRIX_FILE=$(ls ${RESTORE_DIR}/matrix-data-*.tar.gz | head -1)
            if [ -f "$MATRIX_FILE" ]; then
              rm -rf /opt/services/matrix/*
              tar -xzf "$MATRIX_FILE" -C /opt/services/matrix/
              echo "‚úÖ Matrix data restored"
            else
              echo "‚ö†Ô∏è  No Matrix backup found"
            fi
          fi
          
          if [ "$RESTORE_COMPONENTS" = "all" ] || [ "$RESTORE_COMPONENTS" = "jitsi-only" ]; then
            echo "üìπ Restoring Jitsi configs..."
            JITSI_FILE=$(ls ${RESTORE_DIR}/jitsi-*.tar.gz | head -1)
            if [ -f "$JITSI_FILE" ]; then
              rm -rf /opt/services/jitsi/*
              tar -xzf "$JITSI_FILE" -C /opt/services/jitsi/
              echo "‚úÖ Jitsi configs restored"
            else
              echo "‚ö†Ô∏è  No Jitsi backup found"
            fi
          fi
          
          if [ "$RESTORE_COMPONENTS" = "all" ] || [ "$RESTORE_COMPONENTS" = "wireguard-only" ]; then
            echo "üîê Restoring WireGuard configs..."
            WG_FILE=$(ls ${RESTORE_DIR}/wireguard-[0-9]*.tar.gz | head -1)
            WGUI_FILE=$(ls ${RESTORE_DIR}/wireguard-ui-*.tar.gz | head -1)
            if [ -f "$WG_FILE" ]; then
              rm -rf /etc/wireguard/*
              tar -xzf "$WG_FILE" -C /etc/
              echo "‚úÖ WireGuard server configs restored"
            fi
            if [ -f "$WGUI_FILE" ]; then
              rm -rf /opt/services/wireguard-ui/*
              tar -xzf "$WGUI_FILE" -C /opt/services/wireguard-ui/
              echo "‚úÖ WireGuard UI data restored"
            fi
            if [ ! -f "$WG_FILE" ] && [ ! -f "$WGUI_FILE" ]; then
              echo "‚ö†Ô∏è  No WireGuard backup found"
            fi
          fi
          
          if [ "$RESTORE_COMPONENTS" = "all" ] || [ "$RESTORE_COMPONENTS" = "traefik-only" ]; then
            echo "üîí Restoring Traefik SSL certificates..."
            TRAEFIK_FILE=$(ls ${RESTORE_DIR}/traefik-*.tar.gz | head -1)
            if [ -f "$TRAEFIK_FILE" ]; then
              rm -rf /opt/services/traefik/*
              tar -xzf "$TRAEFIK_FILE" -C /opt/services/traefik/
              chmod 600 /opt/services/traefik/acme/acme.json
              echo "‚úÖ Traefik configs restored"
            else
              echo "‚ö†Ô∏è  No Traefik backup found"
            fi
          fi
          
          # Cleanup restore files
          echo "üßπ Cleaning up..."
          rm -rf "${RESTORE_DIR}"
          
          # Restart all services
          echo "üîÑ Restarting all services..."
          cd /opt/services
          docker compose down
          docker compose up -d
          
          echo "‚è≥ Waiting for services to start..."
          sleep 15
          
          echo "üìä Service status:"
          docker compose ps
          
          echo "========================================"
          echo "‚úÖ Restore completed successfully!"
          echo "Finished at: $(date)"
          echo "========================================"
          EOF

      - name: Health check after restore
        run: |
          sleep 30
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP || '46.224.49.30' }} << 'EOF'
          echo "üè• Running health checks..."
          
          echo "Checking Matrix Synapse..."
          curl -sf https://matrix.${{ secrets.DOMAIN_NAME }}/_matrix/client/versions > /dev/null && echo "‚úÖ Matrix OK" || echo "‚ùå Matrix FAILED"
          
          echo "Checking Element Web..."
          curl -sf https://chat.${{ secrets.DOMAIN_NAME }} > /dev/null && echo "‚úÖ Element OK" || echo "‚ùå Element FAILED"
          
          echo "Checking Jitsi Meet..."
          curl -sf https://meet.${{ secrets.DOMAIN_NAME }} > /dev/null && echo "‚úÖ Jitsi OK" || echo "‚ùå Jitsi FAILED"
          
          echo "Checking WireGuard UI..."
          curl -sf https://vpn.${{ secrets.DOMAIN_NAME }} > /dev/null && echo "‚úÖ WireGuard UI OK" || echo "‚ùå WireGuard UI FAILED"
          
          echo "Checking Traefik..."
          curl -sf https://${{ secrets.DOMAIN_NAME }}:8080/api/http/routers > /dev/null && echo "‚úÖ Traefik OK" || echo "‚ùå Traefik FAILED"
          EOF

      - name: Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Restore completed successfully"
            echo "All services have been restarted"
            echo "Please verify functionality at your URLs"
          else
            echo "‚ùå Restore failed"
            echo "Check logs above for details"
            echo "Services may be in inconsistent state - manual intervention may be required"
          fi
