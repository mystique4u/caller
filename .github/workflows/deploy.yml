name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'ansible/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
      skip_validation:
        description: 'Skip validation stages (not recommended)'
        required: false
        default: false
        type: boolean

env:
  TERRAFORM_VERSION: '1.6.0'
  # Terraform Cloud authentication (for state storage only)
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  # Variables from GitHub Secrets
  TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
  TF_VAR_firewall_name: ${{ secrets.FIREWALL_NAME }}
  TF_VAR_ssh_key_ids: ${{ secrets.SSH_KEY_IDS }}
  TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_validation != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for potential secrets..."
          if grep -r -i -E "(password|secret|api_key|token).*=.*['\"][^'\"]{8,}['\"]" terraform/ ansible/ 2>/dev/null; then
            echo "::error::Found potential hardcoded secrets!"
            exit 1
          fi
          echo "âœ… No hardcoded secrets detected"
          
      - name: Check file permissions
        run: |
          echo "ðŸ” Checking for executable files..."
          find . -type f -name "*.tf" -executable -o -name "*.yml" -executable -o -name "*.yaml" -executable | while read file; do
            echo "::warning::File should not be executable: $file"
          done
          
      - name: Validate Ansible syntax
        run: |
          echo "ðŸ” Installing Ansible..."
          pip install ansible ansible-lint
          echo "âœ… Checking Ansible playbook syntax..."
          for playbook in ansible/*.yml; do
            if [ -f "$playbook" ]; then
              ansible-playbook --syntax-check "$playbook" || exit 1
            fi
          done
          echo "âœ… Ansible syntax valid"

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_validation != 'true'
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          
      - name: Terraform Format Check
        id: fmt
        run: |
          echo "ðŸ” Checking Terraform formatting..."
          terraform fmt -check -recursive
          echo "âœ… Terraform files are properly formatted"
        
      - name: Terraform Init
        id: init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
          echo "âœ… Terraform initialized"
        
      - name: Terraform Validate
        id: validate
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          terraform validate -no-color
          echo "âœ… Terraform configuration is valid"
          
      - name: Check for Terraform best practices
        run: |
          echo "ðŸ” Checking Terraform best practices..."
          # Check for missing descriptions
          if grep -n "variable.*{" main.tf | grep -v "description"; then
            echo "::warning::Some variables are missing descriptions"
          fi
          echo "âœ… Best practices check complete"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_validation != 'true'
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          
      - name: Terraform Init
        run: terraform init
        
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: true
          
      - name: Check for common security issues
        run: |
          echo "ðŸ” Checking for common security misconfigurations..."
          # Check for overly permissive firewall rules
          if grep -n "0.0.0.0/0" main.tf | grep -v "#"; then
            echo "::warning::Found potential overly permissive firewall rules"
          fi
          echo "âœ… Security check complete"

  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [code-quality, terraform-validate, security-scan]
    if: |
      always() &&
      (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped') &&
      (needs.terraform-validate.result == 'success' || needs.terraform-validate.result == 'skipped') &&
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    defaults:
      run:
        working-directory: ./terraform
    
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
      has_changes: ${{ steps.plan.outputs.exitcode == '2' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          
      - name: Terraform Init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
        
      - name: Terraform Plan
        id: plan
        run: |
          echo "ðŸ“‹ Creating Terraform plan..."
          terraform plan -detailed-exitcode -no-color -out=tfplan || export exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          
          # Save plan output for review
          terraform show -no-color tfplan > plan_output.txt 2>&1 || true
          
          exit ${exitcode}
        continue-on-error: true
        
      - name: Upload Plan
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            terraform/tfplan
            terraform/plan_output.txt
          retention-days: 5
          
      - name: Create Plan Summary
        if: steps.plan.outputs.exitcode == '2'
        run: |
          echo "## ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes detected! Review the plan before applying:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```terraform' >> $GITHUB_STEP_SUMMARY
          head -n 100 plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To apply these changes, trigger workflow with 'apply' action." >> $GITHUB_STEP_SUMMARY
          
      - name: Plan Status
        run: |
          exitcode="${{ steps.plan.outputs.exitcode }}"
          if [ "$exitcode" == "0" ]; then
            echo "âœ… No infrastructure changes detected"
          elif [ "$exitcode" == "2" ]; then
            echo "ðŸ“‹ Infrastructure changes detected - review plan before applying"
            echo "::notice::Changes detected. Run workflow with 'apply' action to deploy."
          else
            echo "âŒ Plan failed - check logs for details"
            exit 1
          fi

  approval-gate:
    name: Deployment Approval Required
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.outputs.plan_exitcode == '2'
    
    steps:
      - name: Approval Notice
        run: |
          echo "ðŸš¦ Deployment requires manual approval"
          echo "Review the Terraform plan in the artifacts before proceeding"
          echo "Changes will be applied to production infrastructure"
          
  terraform:
    name: Terraform Apply (Manual)
    runs-on: ubuntu-latest
    needs: [plan, approval-gate]
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply' &&
      needs.plan.result == 'success'
    environment:
      name: production
      url: https://${{ secrets.DOMAIN_NAME }}
    defaults:
      run:
        working-directory: ./terraform
    
    outputs:
      public_ip: ${{ steps.terraform_output.outputs.public_ip }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          
      - name: Terraform Init
        run: |
          echo "ðŸ”§ Initializing Terraform..."
          terraform init
        
      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/
        continue-on-error: true
        
      - name: Terraform Apply
        id: apply
        run: |
          echo "ðŸš€ Applying Terraform changes..."
          if [ -f "tfplan" ]; then
            echo "Using pre-generated plan"
            terraform apply -auto-approve tfplan
          else
            echo "No plan found, creating new plan and applying"
            terraform apply -auto-approve -input=false
          fi
          echo "âœ… Infrastructure deployed successfully"
          
      - name: Get Terraform Outputs
        id: terraform_output
        if: steps.apply.outcome == 'success'
        run: |
          PUBLIC_IP=$(terraform output -raw public_ip)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $PUBLIC_IP"
          
      - name: Save Terraform Outputs
        if: steps.apply.outcome == 'success'
        run: |
          terraform output -json > outputs.json
          
      - name: Upload Terraform Outputs
        if: steps.apply.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/outputs.json
          retention-days: 30

  ansible:
    name: Configure Server
    runs-on: ubuntu-latest
    needs: terraform
    if: |
      always() &&
      needs.terraform.result == 'success' &&
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.action == 'apply'
    if: needs.terraform.outputs.public_ip != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ needs.terraform.outputs.public_ip }} >> ~/.ssh/known_hosts
          
      - name: Create dynamic inventory
        working-directory: ./ansible
        run: |
          cat > inventory.ini << EOF
          [wireguard]
          wireguard-vpn-server ansible_host=${{ needs.terraform.outputs.public_ip }}

          [wireguard:vars]
          ansible_user=root
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF
          
      - name: Wait for SSH to be ready
        run: |
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@${{ needs.terraform.outputs.public_ip }} 'echo SSH is ready'; then
              echo "SSH connection established"
              break
            fi
            echo "Waiting for SSH... attempt $i/30"
            sleep 10
          done
          
      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        run: |
          ansible-playbook -i inventory.ini playbook.yml -v
          
      - name: Display connection information
        run: |
          echo "ðŸŽ‰ WireGuard VPN Server deployed successfully!"
          echo "ðŸ“ Server IP: ${{ needs.terraform.outputs.public_ip }}"
          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            echo "ðŸŒ Domain: ${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ”’ WireGuard UI: https://vpn.${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ“¹ GalÃ¨ne Video: https://meet.${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ“Š Traefik Dashboard: https://${{ secrets.DOMAIN_NAME }}:8080/dashboard/"
            echo ""
            echo "âš ï¸  DNS Configuration Required:"
            echo "   Update nameservers at your domain registrar to:"
            echo "   - hydrogen.ns.hetzner.com"
            echo "   - oxygen.ns.hetzner.com"
            echo "   - helium.ns.hetzner.de"
          else
            echo "ðŸŒ WireGuard UI: http://${{ needs.terraform.outputs.public_ip }}/wireguard"
            echo "ðŸ“¹ GalÃ¨ne Video: http://${{ needs.terraform.outputs.public_ip }}/galene"
            echo "ðŸ“Š Traefik Dashboard: http://${{ needs.terraform.outputs.public_ip }}:8080/dashboard/"
          fi
