name: Manual Backup to Storage Box

on:
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Backup type'
        required: true
        type: choice
        options:
          - 'full'
          - 'database-only'
          - 'configs-only'
        default: 'full'

jobs:
  backup:
    name: Backup to Storage Box
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP || '46.224.49.30' }} >> ~/.ssh/known_hosts

      - name: Run backup on server
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP || '46.224.49.30' }} << 'EOF'
          set -e
          
          BACKUP_TYPE="${{ github.event.inputs.backup_type }}"
          STORAGEBOX_HOST="${{ secrets.STORAGEBOX_HOST }}"
          STORAGEBOX_USER="${{ secrets.STORAGEBOX_USER }}"
          STORAGEBOX_PASSWORD="${{ secrets.STORAGEBOX_PASSWORD }}"
          STORAGEBOX_PORT="23"
          REMOTE_BASE="/home/backups/hosts/caller"
          BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
          LOCAL_BACKUP_DIR="/tmp/backup-${BACKUP_DATE}"
          
          echo "========================================"
          echo "Manual Backup - Type: ${BACKUP_TYPE}"
          echo "Started at: $(date)"
          echo "========================================"
          
          mkdir -p "${LOCAL_BACKUP_DIR}"
          
          if [ "$BACKUP_TYPE" = "full" ] || [ "$BACKUP_TYPE" = "database-only" ]; then
            echo "ðŸ“¦ Backing up PostgreSQL database..."
            docker exec matrix-postgres pg_dump -U synapse synapse | gzip > "${LOCAL_BACKUP_DIR}/matrix-postgres-${BACKUP_DATE}.sql.gz"
            echo "âœ… Database backup complete"
          fi
          
          if [ "$BACKUP_TYPE" = "full" ] || [ "$BACKUP_TYPE" = "configs-only" ]; then
            echo "ðŸ“¦ Backing up Matrix Synapse data..."
            tar -czf "${LOCAL_BACKUP_DIR}/matrix-data-${BACKUP_DATE}.tar.gz" -C /opt/services/matrix .
            
            echo "ðŸ“¦ Backing up Jitsi configs..."
            tar -czf "${LOCAL_BACKUP_DIR}/jitsi-${BACKUP_DATE}.tar.gz" -C /opt/services/jitsi .
            
            echo "ðŸ“¦ Backing up WireGuard configs..."
            tar -czf "${LOCAL_BACKUP_DIR}/wireguard-${BACKUP_DATE}.tar.gz" -C /etc wireguard
            tar -czf "${LOCAL_BACKUP_DIR}/wireguard-ui-${BACKUP_DATE}.tar.gz" -C /opt/services/wireguard-ui .
            
            echo "ðŸ“¦ Backing up Traefik SSL certificates..."
            tar -czf "${LOCAL_BACKUP_DIR}/traefik-${BACKUP_DATE}.tar.gz" -C /opt/services/traefik .
            echo "âœ… Configs backup complete"
          fi
          
          echo "ðŸ“ Creating manifest..."
          cat > "${LOCAL_BACKUP_DIR}/MANIFEST.txt" << MANIFEST
          ==========================================
          Backup Manifest
          ==========================================
          Backup Type: ${BACKUP_TYPE}
          Date: $(date)
          Hostname: $(hostname)
          IP Address: $(hostname -I | awk '{print $1}')
          
          Files in this backup:
          $(ls -lh ${LOCAL_BACKUP_DIR})
          
          Total backup size: $(du -sh ${LOCAL_BACKUP_DIR} | awk '{print $1}')
          
          Service Status:
          $(docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "matrix|jitsi|wireguard|traefik")
          ==========================================
          MANIFEST
          
          echo "â˜ï¸  Uploading to Storage Box..."
          lftp -u "${STORAGEBOX_USER},${STORAGEBOX_PASSWORD}" -p ${STORAGEBOX_PORT} sftp://${STORAGEBOX_HOST} << LFTP_COMMANDS
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          cd ${REMOTE_BASE}
          lcd ${LOCAL_BACKUP_DIR}
          mput *
          bye
          LFTP_COMMANDS
          
          echo "ðŸ§¹ Cleaning up local files..."
          rm -rf "${LOCAL_BACKUP_DIR}"
          
          echo "========================================"
          echo "âœ… Backup completed successfully!"
          echo "Finished at: $(date)"
          echo "========================================"
          EOF

      - name: Verify backup
        run: |
          ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP || '46.224.49.30' }} << 'EOF'
          echo "ðŸ“‹ Recent backups on Storage Box:"
          lftp -u "${{ secrets.STORAGEBOX_USER }},${{ secrets.STORAGEBOX_PASSWORD }}" -p 23 sftp://${{ secrets.STORAGEBOX_HOST }} << LFTP_LIST
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          cd /home/backups/hosts/caller
          cls -l --sort=date | head -10
          bye
          LFTP_LIST
          EOF

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Backup completed successfully"
          else
            echo "âŒ Backup failed"
          fi
