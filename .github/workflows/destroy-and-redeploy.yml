name: Destroy and Redeploy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_destroy == 'DESTROY'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Destroy
        working-directory: ./terraform
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_firewall_name: ${{ secrets.FIREWALL_NAME }}
          TF_VAR_ssh_key_ids: ${{ secrets.SSH_KEY_IDS }}
          TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}
        run: terraform destroy -auto-approve

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: destroy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: ./terraform
        env:
          TF_VAR_hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          TF_VAR_firewall_name: ${{ secrets.FIREWALL_NAME }}
          TF_VAR_ssh_key_ids: ${{ secrets.SSH_KEY_IDS }}
          TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}
        run: terraform apply -auto-approve

      - name: Get Server IP
        id: server_ip
        working-directory: ./terraform
        run: |
          SERVER_IP=$(terraform output -raw public_ip)
          echo "ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $SERVER_IP"

      - name: Wait for SSH
        run: |
          echo "Waiting for SSH to be available..."
          for i in {1..30}; do
            if ssh-keyscan -H ${{ steps.server_ip.outputs.ip }} 2>/dev/null | grep -q ssh; then
              echo "SSH is ready!"
              break
            fi
            echo "Attempt $i: SSH not ready yet, waiting..."
            sleep 10
          done

  configure:
    name: Configure with Ansible
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Get Server IP
        id: server_ip
        working-directory: ./terraform
        run: |
          terraform init
          SERVER_IP=$(terraform output -raw public_ip)
          echo "ip=$SERVER_IP" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.server_ip.outputs.ip }} >> ~/.ssh/known_hosts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Create Ansible Inventory
        working-directory: ./ansible
        run: |
          cat > inventory.ini << EOF
          [wireguard]
          ${{ steps.server_ip.outputs.ip }} ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa
          EOF

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        run: ansible-playbook -i inventory.ini playbook.yml

      - name: Display Access Information
        run: |
          echo "================================================"
          echo "WireGuard VPN Server Deployed Successfully!"
          echo "================================================"
          echo "Server IP: ${{ steps.server_ip.outputs.ip }}"
          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            echo ""
            echo "ðŸŒ Domain: ${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ”’ WireGuard UI: https://vpn.${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ“¹ GalÃ¨ne Video: https://meet.${{ secrets.DOMAIN_NAME }}"
            echo "ðŸ“Š Traefik Dashboard: https://${{ secrets.DOMAIN_NAME }}:8080/dashboard/"
            echo ""
            echo "âš ï¸  DNS Configuration Required:"
            echo "   Update nameservers at your domain registrar to:"
            echo "   - hydrogen.ns.hetzner.com"
            echo "   - oxygen.ns.hetzner.com"
            echo "   - helium.ns.hetzner.de"
          else
            echo ""
            echo "ðŸŒ WireGuard UI: http://${{ steps.server_ip.outputs.ip }}/wireguard"
            echo "ðŸ“¹ GalÃ¨ne Video: http://${{ steps.server_ip.outputs.ip }}/galene"
            echo "ðŸ“Š Traefik Dashboard: http://${{ steps.server_ip.outputs.ip }}:8080/dashboard/"
          fi
          echo ""
          echo "Default credentials: admin / admin (CHANGE IMMEDIATELY!)"
          echo "================================================"
