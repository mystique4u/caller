---
- name: Setup VPN and Services Server
  hosts: all
  become: yes
  gather_facts: yes
  environment:
    ANSIBLE_REMOTE_TEMP: /tmp/.ansible/tmp

  vars:
    server_ip: "{{ ansible_host }}"
    domain_name: "{{ lookup('env', 'DOMAIN_NAME') }}"
    email_address: "{{ lookup('env', 'EMAIL_ADDRESS') }}"
    letsencrypt_env: "{{ lookup('env', 'LETSENCRYPT_ENV') | default('production', true) }}"
    wireguard_port: 51820
    wireguard_ui_version: "0.6.2"
    jitsi_web_image: "jitsi/web:stable"
    jitsi_prosody_image: "jitsi/prosody:stable"
    jitsi_jicofo_image: "jitsi/jicofo:stable"
    jitsi_jvb_image: "jitsi/jvb:stable"
    matrix_synapse_image: "matrixdotorg/synapse:latest"
    matrix_postgres_image: "postgres:15-alpine"
    element_web_image: "vectorim/element-web:latest"
    matrix_admin_user: "{{ lookup('env', 'MATRIX_ADMIN_USER') | default('admin', true) }}"
    matrix_admin_password: "{{ lookup('env', 'MATRIX_ADMIN_PASSWORD') }}"
    matrix_registration_secret: "{{ lookup('env', 'MATRIX_REGISTRATION_SECRET') }}"
    postgres_password: "{{ lookup('env', 'MATRIX_POSTGRES_PASSWORD') }}"

  tasks:
    - name: Wait for server to be ready
      wait_for_connection:
        timeout: 300
        delay: 5

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - wireguard
          - wireguard-tools
          - iptables
          - net-tools
          - htop
          - vim
          - wget
          - git
          - python3-pip
        state: present

    # Docker Installation
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Enable IP forwarding for VPN
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv4.conf.all.forwarding
        - net.ipv6.conf.all.forwarding

    - name: Install Docker SDK for Python (Ubuntu 24.04 compatible)
      apt:
        name:
          - python3-docker
        state: present
      ignore_errors: yes

    # Note: We don't need docker-compose Python package
    # Docker Compose V2 is included with docker-compose-plugin
    # The 'docker compose' command is available via the plugin

    # WireGuard Configuration
    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    - name: Generate WireGuard server private key
      shell: wg genkey
      register: wg_private_key
      changed_when: false
      no_log: true

    - name: Generate WireGuard server public key
      shell: echo "{{ wg_private_key.stdout }}" | wg pubkey
      register: wg_public_key
      changed_when: false

    - name: Create WireGuard server configuration
      copy:
        content: |
          [Interface]
          Address = 10.0.0.1/24
          ListenPort = {{ wireguard_port }}
          PrivateKey = {{ wg_private_key.stdout }}

          PostUp = iptables -I DOCKER-USER -i wg0 -j ACCEPT; iptables -I DOCKER-USER -o wg0 -j ACCEPT; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          PostDown = iptables -D DOCKER-USER -i wg0 -j ACCEPT; iptables -D DOCKER-USER -o wg0 -j ACCEPT; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      no_log: true

    - name: Start and enable WireGuard
      systemd:
        name: wg-quick@wg0
        state: started
        enabled: yes

    # Docker Compose for Services
    - name: Create docker compose directory
      file:
        path: /opt/services
        state: directory
        mode: '0755'

    - name: Create service directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/services/wireguard-ui
        - /opt/services/traefik/dynamic
        - /opt/services/traefik/acme
        - /opt/services/jitsi/prosody/config
        - /opt/services/jitsi/prosody/prosody-plugins-custom
        - /opt/services/matrix/synapse
        - /opt/services/matrix/postgres
        - /opt/services/matrix/element

    - name: Create Traefik static configuration with HTTPS
      copy:
        content: |
          [global]
            checkNewVersion = false
            sendAnonymousUsage = false

          [api]
            dashboard = true
            insecure = false

          [entryPoints]
            [entryPoints.web]
              address = ":80"
              [entryPoints.web.http.redirections.entryPoint]
                to = "websecure"
                scheme = "https"

            [entryPoints.websecure]
              address = ":443"

            [entryPoints.traefik]
              address = ":8080"

          [certificatesResolvers.letsencrypt.acme]
            email = "{{ email_address }}"
            storage = "/acme/acme.json"
            {% if letsencrypt_env == 'staging' %}
            caServer = "https://acme-staging-v02.api.letsencrypt.org/directory"
            {% endif %}
            [certificatesResolvers.letsencrypt.acme.httpChallenge]
              entryPoint = "web"

          [providers]
            [providers.docker]
              endpoint = "unix:///var/run/docker.sock"
              exposedByDefault = false

          [log]
            level = "INFO"
        dest: /opt/services/traefik/traefik.toml
        mode: '0644'

    - name: Create Docker Compose file with HTTPS
      copy:
        content: |
          services:
            traefik:
              image: traefik:v2.11
              container_name: traefik
              restart: unless-stopped
              ports:
                - "80:80"
                - "443:443"
                - "8080:8080"
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
                - /opt/services/traefik/traefik.toml:/etc/traefik/traefik.toml:ro
                - /opt/services/traefik/dynamic:/etc/traefik/dynamic:ro
                - /opt/services/traefik/acme:/acme
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.dashboard.rule=Host(`{{ domain_name }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
                - "traefik.http.routers.dashboard.service=api@internal"
                - "traefik.http.routers.dashboard.entrypoints=websecure"
                - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"

            wireguard-ui:
              image: ngoduykhanh/wireguard-ui:{{ wireguard_ui_version }}
              container_name: wireguard-ui
              restart: unless-stopped
              cap_add:
                - NET_ADMIN
                - SYS_MODULE
              sysctls:
                - net.ipv4.ip_forward=1
                - net.ipv4.conf.all.src_valid_mark=1
              privileged: true
              environment:
                - WGUI_USERNAME=admin
                - WGUI_PASSWORD=admin
                - WGUI_SESSION_SECRET=supersecretkey123456789012345678901234567890
                - WGUI_ENDPOINT_ADDRESS=vpn.{{ domain_name }}
                - WGUI_DNS=1.1.1.1,1.0.0.1
                - WGUI_MTU=1420
                - WGUI_PERSISTENT_KEEPALIVE=25
                - WGUI_SERVER_INTERFACE_ADDRESSES=10.0.0.1/24
                - WGUI_SERVER_LISTEN_PORT={{ wireguard_port }}
                - WGUI_SERVER_POST_UP_SCRIPT=iptables -I DOCKER-USER -i wg0 -j ACCEPT; iptables -I DOCKER-USER -o wg0 -j ACCEPT; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
                - WGUI_SERVER_POST_DOWN_SCRIPT=iptables -D DOCKER-USER -i wg0 -j ACCEPT; iptables -D DOCKER-USER -o wg0 -j ACCEPT; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
              volumes:
                - /opt/services/wireguard-ui:/app/db
                - /etc/wireguard:/etc/wireguard
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.wireguard.rule=Host(`vpn.{{ domain_name }}`)"
                - "traefik.http.routers.wireguard.entrypoints=websecure"
                - "traefik.http.services.wireguard.loadbalancer.server.port=5000"
                - "traefik.http.routers.wireguard.tls.certresolver=letsencrypt"

            jitsi-web:
              image: "{{ jitsi_web_image }}"
              container_name: jitsi-web
              restart: unless-stopped
              environment:
                - ENABLE_AUTH=1
                - ENABLE_GUESTS=0
                - AUTH_TYPE=internal
                - PUBLIC_URL=https://meet.{{ domain_name }}
                - XMPP_DOMAIN=meet.jitsi
                - XMPP_AUTH_DOMAIN=auth.meet.jitsi
                - XMPP_BOSH_URL_BASE=http://jitsi-prosody:5280
                - XMPP_MUC_DOMAIN=muc.meet.jitsi
                - JVB_TCP_HARVESTER_DISABLED=true
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.jitsi.rule=Host(`meet.{{ domain_name }}`)"
                - "traefik.http.routers.jitsi.entrypoints=websecure"
                - "traefik.http.services.jitsi.loadbalancer.server.port=80"
                - "traefik.http.services.jitsi.loadbalancer.server.scheme=http"
                - "traefik.http.routers.jitsi.tls.certresolver=letsencrypt"

            jitsi-prosody:
              image: "{{ jitsi_prosody_image }}"
              container_name: jitsi-prosody
              restart: unless-stopped
              environment:
                - XMPP_DOMAIN=meet.jitsi
                - XMPP_AUTH_DOMAIN=auth.meet.jitsi
                - XMPP_MUC_DOMAIN=muc.meet.jitsi
                - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
                - JICOFO_COMPONENT_SECRET=jicofo_secret
                - JICOFO_AUTH_PASSWORD=focus_password
                - JVB_AUTH_USER=jvb
                - JVB_AUTH_PASSWORD=jvb_password
                - ENABLE_AUTH=1
                - ENABLE_GUESTS=0
                - AUTH_TYPE=internal
              volumes:
                - /opt/services/jitsi/prosody/config:/config
                - /opt/services/jitsi/prosody/prosody-plugins-custom:/prosody-plugins-custom
              networks:
                - services

            jitsi-jicofo:
              image: "{{ jitsi_jicofo_image }}"
              container_name: jitsi-jicofo
              restart: unless-stopped
              environment:
                - XMPP_DOMAIN=meet.jitsi
                - XMPP_AUTH_DOMAIN=auth.meet.jitsi
                - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
                - XMPP_SERVER=jitsi-prosody
                - JICOFO_COMPONENT_SECRET=jicofo_secret
                - JICOFO_AUTH_USER=focus
                - JICOFO_AUTH_PASSWORD=focus_password
              networks:
                - services

            jitsi-jvb:
              image: "{{ jitsi_jvb_image }}"
              container_name: jitsi-jvb
              restart: unless-stopped
              ports:
                - "10000:10000/udp"
              environment:
                - XMPP_AUTH_DOMAIN=auth.meet.jitsi
                - XMPP_INTERNAL_MUC_DOMAIN=internal-muc.meet.jitsi
                - XMPP_SERVER=jitsi-prosody
                - JVB_AUTH_USER=jvb
                - JVB_AUTH_PASSWORD=jvb_password
                - JVB_STUN_SERVERS=meet-jit-si-turnrelay.jitsi.net:443
                - JVB_PORT=10000
                - PUBLIC_URL=https://meet.{{ domain_name }}
              networks:
                - services

            matrix-postgres:
              image: "{{ matrix_postgres_image }}"
              container_name: matrix-postgres
              restart: unless-stopped
              environment:
                - POSTGRES_DB=synapse
                - POSTGRES_USER=synapse
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
              volumes:
                - /opt/services/matrix/postgres:/var/lib/postgresql/data
              networks:
                - services

            matrix-synapse:
              image: "{{ matrix_synapse_image }}"
              container_name: matrix-synapse
              restart: unless-stopped
              environment:
                - SYNAPSE_SERVER_NAME={{ domain_name }}
                - SYNAPSE_REPORT_STATS=no
                - SYNAPSE_ENABLE_REGISTRATION=no
                - SYNAPSE_REGISTRATION_SHARED_SECRET={{ matrix_registration_secret }}
                - POSTGRES_HOST=matrix-postgres
                - POSTGRES_USER=synapse
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_DB=synapse
              volumes:
                - /opt/services/matrix/synapse:/data
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.matrix.rule=Host(`matrix.{{ domain_name }}`)"
                - "traefik.http.routers.matrix.entrypoints=websecure"
                - "traefik.http.services.matrix.loadbalancer.server.port=8008"
                - "traefik.http.services.matrix.loadbalancer.server.scheme=http"
                - "traefik.http.routers.matrix.tls.certresolver=letsencrypt"
              depends_on:
                - matrix-postgres

            element-web:
              image: "{{ element_web_image }}"
              container_name: element-web
              restart: unless-stopped
              volumes:
                - /opt/services/matrix/element/config.json:/app/config.json:ro
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.element.rule=Host(`chat.{{ domain_name }}`)"
                - "traefik.http.routers.element.entrypoints=websecure"
                - "traefik.http.services.element.loadbalancer.server.port=80"
                - "traefik.http.services.element.loadbalancer.server.scheme=http"
                - "traefik.http.routers.element.tls.certresolver=letsencrypt"

          networks:
            services:
              name: services_network
              driver: bridge
        dest: /opt/services/docker-compose.yml
        mode: '0644'

    - name: Check if Let's Encrypt certificates already exist
      stat:
        path: /opt/services/traefik/acme/acme.json
      register: acme_file

    - name: Create acme.json if it doesn't exist
      file:
        path: /opt/services/traefik/acme/acme.json
        state: touch
        mode: '0600'
      when: not acme_file.stat.exists

    - name: Display certificate status
      debug:
        msg: "{{ 'Using existing Let''s Encrypt certificates' if (acme_file.stat.exists and acme_file.stat.size > 0) else 'Will request new Let''s Encrypt certificates (first deployment)' }}"

    - name: Ensure acme.json has correct permissions
      file:
        path: /opt/services/traefik/acme/acme.json
        mode: '0600'
      when: acme_file.stat.exists

    - name: Generate Matrix Synapse configuration
      shell: |
        docker run --rm \
          -v /opt/services/matrix/synapse:/data \
          -e SYNAPSE_SERVER_NAME={{ domain_name }} \
          -e SYNAPSE_REPORT_STATS=no \
          {{ matrix_synapse_image }} generate
      args:
        creates: /opt/services/matrix/synapse/homeserver.yaml

    - name: Configure Matrix Synapse PostgreSQL database
      shell: |
        # Create a proper database configuration block
        cat > /tmp/db_config.yml << 'EOF'
        database:
          name: psycopg2
          args:
            user: synapse
            password: {{ postgres_password }}
            database: synapse
            host: matrix-postgres
            port: 5432
            cp_min: 5
            cp_max: 10
        EOF
        
        # Remove the old database section (everything from 'database:' until next top-level key or EOF)
        awk '
          /^database:/ { skip=1; next }
          /^[a-z_]+:/ && skip { skip=0 }
          !skip { print }
        ' /opt/services/matrix/synapse/homeserver.yaml > /tmp/homeserver_no_db.yaml
        
        # Merge: add database config at the beginning (after initial comments)
        (grep "^#" /opt/services/matrix/synapse/homeserver.yaml || true
         cat /tmp/db_config.yml
         echo ""
         grep -v "^#" /tmp/homeserver_no_db.yaml) > /opt/services/matrix/synapse/homeserver.yaml.new
        
        mv /opt/services/matrix/synapse/homeserver.yaml.new /opt/services/matrix/synapse/homeserver.yaml
        rm -f /tmp/db_config.yml /tmp/homeserver_no_db.yaml
      when: postgres_password is defined

    - name: Enable registration in Matrix (optional)
      lineinfile:
        path: /opt/services/matrix/synapse/homeserver.yaml
        regexp: '^enable_registration:'
        line: 'enable_registration: false'
        backup: yes

    - name: Set registration shared secret
      lineinfile:
        path: /opt/services/matrix/synapse/homeserver.yaml
        regexp: '^registration_shared_secret:'
        line: 'registration_shared_secret: "{{ matrix_registration_secret }}"'
        backup: yes
      when: matrix_registration_secret is defined

    - name: Create Element Web configuration
      copy:
        content: |
          {
            "default_server_config": {
              "m.homeserver": {
                "base_url": "https://matrix.{{ domain_name }}",
                "server_name": "{{ domain_name }}"
              }
            },
            "brand": "Element",
            "integrations_ui_url": "https://scalar.vector.im/",
            "integrations_rest_url": "https://scalar.vector.im/api",
            "integrations_widgets_urls": [
              "https://scalar.vector.im/_matrix/integrations/v1",
              "https://scalar.vector.im/api",
              "https://scalar-staging.vector.im/_matrix/integrations/v1",
              "https://scalar-staging.vector.im/api",
              "https://scalar-staging.riot.im/scalar/api"
            ],
            "bug_report_endpoint_url": "https://element.io/bugreports/submit",
            "defaultCountryCode": "GB",
            "showLabsSettings": true,
            "features": {
              "feature_pinning": "labs",
              "feature_custom_status": "labs",
              "feature_custom_tags": "labs",
              "feature_state_counters": "labs",
              "feature_voice_messages": "labs",
              "feature_thread": "labs"
            },
            "default_federate": true,
            "default_theme": "dark",
            "roomDirectory": {
              "servers": ["{{ domain_name }}"]
            },
            "enable_presence_by_hs_url": {
              "https://matrix.{{ domain_name }}": true
            },
            "settingDefaults": {
              "breadcrumbs": true
            }
          }
        dest: /opt/services/matrix/element/config.json
        mode: '0644'

    - name: Ensure acme.json has correct permissions
      file:
        path: /opt/services/traefik/acme/acme.json
        mode: '0600'
      when: acme_file.stat.exists

    - name: Pull and start Docker services
      shell: |
        cd /opt/services
        docker compose pull --ignore-pull-failures || true
        docker compose down || true
        docker compose up -d
      args:
        executable: /bin/bash
      retries: 3
      delay: 10
      register: docker_result
      until: docker_result.rc == 0

    - name: Remove old Galene container if exists
      community.docker.docker_container:
        name: galene
        state: absent
      ignore_errors: yes

    - name: Wait for services to be ready
      wait_for:
        port: "{{ item }}"
        host: 127.0.0.1
        timeout: 60
        delay: 5
      loop:
        - 80
      ignore_errors: yes

    - name: Wait for Jitsi Prosody to be ready
      wait_for:
        timeout: 30
      delegate_to: localhost

    - name: Fix Jitsi authdomain in config.js
      shell: |
        docker exec jitsi-web sed -i "s/config.hosts.authdomain = 'meet.jitsi';/config.hosts.authdomain = 'auth.meet.jitsi';/g" /config/config.js
        docker exec jitsi-web nginx -s reload
      register: fix_config_result
      failed_when: false
      changed_when: true

    - name: Create Jitsi admin user
      shell: |
        docker exec jitsi-prosody prosodyctl --config /config/prosody.cfg.lua register {{ jitsi_admin_user }} auth.meet.jitsi {{ jitsi_admin_password }}
      register: create_user_result
      failed_when: false
      changed_when: "'already registered' not in create_user_result.stderr"
      when: jitsi_admin_user is defined and jitsi_admin_password is defined

    - name: Wait for Matrix Synapse to be ready
      wait_for:
        timeout: 30
      delegate_to: localhost
      when: matrix_admin_user is defined and matrix_admin_password is defined

    - name: Create Matrix admin user
      shell: |
        docker exec matrix-synapse register_new_matrix_user -u {{ matrix_admin_user }} -p {{ matrix_admin_password }} -a -c /data/homeserver.yaml http://localhost:8008
      register: matrix_user_result
      failed_when: false
      changed_when: "'User ID already taken' not in matrix_user_result.stderr and matrix_user_result.rc == 0"
      when: matrix_admin_user is defined and matrix_admin_password is defined

    - name: Display admin credentials
      debug:
        msg:
          - "=========================================="
          - "Services Admin Access"
          - "=========================================="
          - "Jitsi Meet: https://meet.{{ domain_name }}"
          - "  Username: {{ jitsi_admin_user }}@auth.meet.jitsi"
          - "  Password: (stored in GitHub Secrets)"
          - ""
          - "Matrix/Element: https://chat.{{ domain_name }}"
          - "  Username: @{{ matrix_admin_user }}:{{ domain_name }}"
          - "  Password: (stored in GitHub Secrets)"
          - "  Homeserver: https://matrix.{{ domain_name }}"
          - "=========================================="
      when: jitsi_admin_user is defined or matrix_admin_user is defined
      ignore_errors: yes

    - name: Display WireGuard status
      command: wg show
      register: wg_status
      changed_when: false
      failed_when: false

    - name: Show server information with domain
      debug:
        msg:
          - "=============================================="
          - "VPN and Services Server is Ready with HTTPS!"
          - "=============================================="
          - "Domain: {{ domain_name }}"
          - "Server IP: {{ server_ip }}"
          - ""
          - "Services:"
          - "  - Traefik Dashboard: https://{{ domain_name }}:8080/dashboard/"
          - "  - WireGuard UI: https://vpn.{{ domain_name }}"
          - "    Default login: admin / admin (CHANGE THIS!)"
          - "  - Jitsi Meet: https://meet.{{ domain_name }}"
          - "    No authentication required - ready to use!"
          - ""
          - "DNS Configuration:"
          - "  Update your domain's nameservers to:"
          - "    - hydrogen.ns.hetzner.com"
          - "    - oxygen.ns.hetzner.com"
          - "    - helium.ns.hetzner.de"
          - ""
          - "=============================================="
