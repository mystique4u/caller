---
- name: Setup VPN and Services Server
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    server_ip: "{{ ansible_host }}"
    domain_name: "{{ lookup('env', 'DOMAIN_NAME') | default('', true) }}"
    email_address: "{{ lookup('env', 'EMAIL_ADDRESS') | default('admin@' + domain_name, true) }}"
    wireguard_port: 51820
    wireguard_ui_version: "v0.6.2"
    use_https: "{{ domain_name != '' }}"

  tasks:
    - name: Wait for server to be ready
      wait_for_connection:
        timeout: 300
        delay: 5

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - wireguard
          - wireguard-tools
          - iptables
          - net-tools
          - htop
          - vim
          - wget
          - git
          - python3-pip
        state: present

    # Docker Installation
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Install Docker SDK for Python (Ubuntu 24.04 compatible)
      apt:
        name:
          - python3-docker
        state: present
      ignore_errors: yes

    - name: Install Docker SDK via pip with break-system-packages (fallback)
      pip:
        name:
          - docker
          - docker-compose
        state: present
        extra_args: --break-system-packages
      when: ansible_distribution_version is version('24.04', '>=')
      ignore_errors: yes

    # WireGuard Configuration
    - name: Enable IP forwarding
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.ipv6.conf.all.forwarding

    - name: Create WireGuard directory
      file:
        path: /etc/wireguard
        state: directory
        mode: '0700'

    - name: Generate WireGuard server private key
      shell: wg genkey
      register: wg_private_key
      changed_when: false
      no_log: true

    - name: Generate WireGuard server public key
      shell: echo "{{ wg_private_key.stdout }}" | wg pubkey
      register: wg_public_key
      changed_when: false

    - name: Create WireGuard server configuration
      copy:
        content: |
          [Interface]
          Address = 10.0.0.1/24
          ListenPort = {{ wireguard_port }}
          PrivateKey = {{ wg_private_key.stdout }}

          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
      no_log: true

    - name: Start and enable WireGuard
      systemd:
        name: wg-quick@wg0
        state: started
        enabled: yes

    # Docker Compose for Services
    - name: Create docker compose directory
      file:
        path: /opt/services
        state: directory
        mode: '0755'

    - name: Create service directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/services/wireguard-ui
        - /opt/services/galene/groups
        - /opt/services/galene/data
        - /opt/services/traefik/dynamic
        - /opt/services/traefik/acme

    - name: Create Traefik static configuration with HTTPS
      copy:
        content: |
          [global]
            checkNewVersion = false
            sendAnonymousUsage = false

          [api]
            dashboard = true
            insecure = false

          [entryPoints]
            [entryPoints.web]
              address = ":80"
              {% if use_https %}
              [entryPoints.web.http.redirections.entryPoint]
                to = "websecure"
                scheme = "https"
              {% endif %}

            [entryPoints.websecure]
              address = ":443"

            [entryPoints.traefik]
              address = ":8080"

          {% if use_https %}
          [certificatesResolvers.letsencrypt.acme]
            email = "{{ email_address }}"
            storage = "/acme/acme.json"
            [certificatesResolvers.letsencrypt.acme.httpChallenge]
              entryPoint = "web"
          {% endif %}

          [providers]
            [providers.docker]
              endpoint = "unix:///var/run/docker.sock"
              exposedByDefault = false

          [log]
            level = "INFO"
        dest: /opt/services/traefik/traefik.toml
        mode: '0644'
      when: use_https

    - name: Create Traefik static configuration without HTTPS (IP only)
      copy:
        content: |
          [global]
            checkNewVersion = false
            sendAnonymousUsage = false

          [api]
            dashboard = true
            insecure = true

          [entryPoints]
            [entryPoints.web]
              address = ":80"

          [providers]
            [providers.docker]
              endpoint = "unix:///var/run/docker.sock"
              exposedByDefault = false

          [log]
            level = "INFO"
        dest: /opt/services/traefik/traefik.toml
        mode: '0644'
      when: not use_https

    - name: Create Docker Compose file with HTTPS
      copy:
        content: |
          services:
            traefik:
              image: traefik:v2.11
              container_name: traefik
              restart: unless-stopped
              ports:
                - "80:80"
                - "443:443"
                - "8080:8080"
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
                - /opt/services/traefik/traefik.toml:/etc/traefik/traefik.toml:ro
                - /opt/services/traefik/dynamic:/etc/traefik/dynamic:ro
                - /opt/services/traefik/acme:/acme
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.dashboard.rule=Host(`{{ domain_name }}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
                - "traefik.http.routers.dashboard.service=api@internal"
                - "traefik.http.routers.dashboard.entrypoints=websecure"
                - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"

            wireguard-ui:
              image: ngoduykhanh/wireguard-ui:{{ wireguard_ui_version }}
              container_name: wireguard-ui
              restart: unless-stopped
              cap_add:
                - NET_ADMIN
              environment:
                - WGUI_USERNAME=admin
                - WGUI_PASSWORD=admin
                - WGUI_ENDPOINT_ADDRESS=vpn.{{ domain_name }}
                - WGUI_DNS=1.1.1.1,1.0.0.1
                - WGUI_MTU=1420
                - WGUI_PERSISTENT_KEEPALIVE=25
                - WGUI_SERVER_INTERFACE_ADDRESSES=10.0.0.1/24
                - WGUI_SERVER_LISTEN_PORT={{ wireguard_port }}
                - WGUI_SERVER_POST_UP_SCRIPT=iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
                - WGUI_SERVER_POST_DOWN_SCRIPT=iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
              volumes:
                - /opt/services/wireguard-ui:/app/db
                - /etc/wireguard:/etc/wireguard
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.wireguard.rule=Host(`vpn.{{ domain_name }}`)"
                - "traefik.http.routers.wireguard.entrypoints=websecure"
                - "traefik.http.services.wireguard.loadbalancer.server.port=5000"
                - "traefik.http.routers.wireguard.tls.certresolver=letsencrypt"

            galene:
              image: ghcr.io/galene/galene:latest
              container_name: galene
              restart: unless-stopped
              command: ["-http", "0.0.0.0:8443"]
              volumes:
                - /opt/services/galene/groups:/opt/galene/groups
                - /opt/services/galene/data:/opt/galene/data
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.galene.rule=Host(`meet.{{ domain_name }}`)"
                - "traefik.http.routers.galene.entrypoints=websecure"
                - "traefik.http.services.galene.loadbalancer.server.port=8443"
                - "traefik.http.routers.galene.tls.certresolver=letsencrypt"

          networks:
            services:
              name: services_network
              driver: bridge
        dest: /opt/services/docker-compose.yml
        mode: '0644'
      when: use_https

    - name: Create Docker Compose file without HTTPS (IP only)
      copy:
        content: |
          services:
            traefik:
              image: traefik:v2.11
              container_name: traefik
              restart: unless-stopped
              ports:
                - "80:80"
                - "8080:8080"
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
                - /opt/services/traefik/traefik.toml:/etc/traefik/traefik.toml:ro
                - /opt/services/traefik/dynamic:/etc/traefik/dynamic:ro
              networks:
                - services

            wireguard-ui:
              image: ngoduykhanh/wireguard-ui:{{ wireguard_ui_version }}
              container_name: wireguard-ui
              restart: unless-stopped
              cap_add:
                - NET_ADMIN
              environment:
                - WGUI_USERNAME=admin
                - WGUI_PASSWORD=admin
                - WGUI_ENDPOINT_ADDRESS={{ server_ip }}
                - WGUI_DNS=1.1.1.1,1.0.0.1
                - WGUI_MTU=1420
                - WGUI_PERSISTENT_KEEPALIVE=25
                - WGUI_SERVER_INTERFACE_ADDRESSES=10.0.0.1/24
                - WGUI_SERVER_LISTEN_PORT={{ wireguard_port }}
                - WGUI_SERVER_POST_UP_SCRIPT=iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
                - WGUI_SERVER_POST_DOWN_SCRIPT=iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
              volumes:
                - /opt/services/wireguard-ui:/app/db
                - /etc/wireguard:/etc/wireguard
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.wireguard.rule=Host(`{{ server_ip }}`) && PathPrefix(`/wireguard`)"
                - "traefik.http.routers.wireguard.entrypoints=web"
                - "traefik.http.services.wireguard.loadbalancer.server.port=5000"
                - "traefik.http.middlewares.wireguard-strip.stripprefix.prefixes=/wireguard"
                - "traefik.http.routers.wireguard.middlewares=wireguard-strip"

            galene:
              image: ghcr.io/galene/galene:latest
              container_name: galene
              restart: unless-stopped
              command: ["-http", "0.0.0.0:8443", "-insecure"]
              volumes:
                - /opt/services/galene/groups:/opt/galene/groups
                - /opt/services/galene/data:/opt/galene/data
              networks:
                - services
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.galene.rule=Host(`{{ server_ip }}`) && PathPrefix(`/galene`)"
                - "traefik.http.routers.galene.entrypoints=web"
                - "traefik.http.services.galene.loadbalancer.server.port=8443"
                - "traefik.http.middlewares.galene-strip.stripprefix.prefixes=/galene"
                - "traefik.http.routers.galene.middlewares=galene-strip"

          networks:
            services:
              name: services_network
              driver: bridge
        dest: /opt/services/docker-compose.yml
        mode: '0644'
      when: not use_https

    - name: Create Galène default group configuration
      copy:
        content: |
          {
            "op": [{"password": "admin"}],
            "presenter": [{}],
            "public": true,
            "description": "Public meeting room",
            "allow-recording": true
          }
        dest: /opt/services/galene/groups/public.json
        mode: '0644'

    - name: Set correct permissions for acme.json
      file:
        path: /opt/services/traefik/acme/acme.json
        state: touch
        mode: '0600'
      when: use_https

    - name: Pull and start Docker services
      shell: |
        cd /opt/services
        docker compose pull
        docker compose up -d
      args:
        executable: /bin/bash

    - name: Wait for services to be ready
      wait_for:
        port: "{{ item }}"
        host: 127.0.0.1
        timeout: 60
        delay: 5
      loop:
        - 80
      ignore_errors: yes

    - name: Display WireGuard status
      command: wg show
      register: wg_status
      changed_when: false
      failed_when: false

    - name: Show server information with domain
      debug:
        msg:
          - "=============================================="
          - "VPN and Services Server is Ready with HTTPS!"
          - "=============================================="
          - "Domain: {{ domain_name }}"
          - "Server IP: {{ server_ip }}"
          - ""
          - "Services:"
          - "  - Traefik Dashboard: https://{{ domain_name }}:8080/dashboard/"
          - "  - WireGuard UI: https://vpn.{{ domain_name }}"
          - "    Default login: admin / admin (CHANGE THIS!)"
          - "  - Galène Video: https://meet.{{ domain_name }}"
          - "    Room: public (operator password: admin)"
          - ""
          - "DNS Configuration:"
          - "  Update your domain's nameservers to:"
          - "    - hydrogen.ns.hetzner.com"
          - "    - oxygen.ns.hetzner.com"
          - "    - helium.ns.hetzner.de"
          - ""
          - "=============================================="
      when: use_https

    - name: Show server information without domain
      debug:
        msg:
          - "=============================================="
          - "VPN and Services Server is Ready (HTTP only)!"
          - "=============================================="
          - "Server IP: {{ server_ip }}"
          - ""
          - "Services:"
          - "  - Traefik Dashboard: http://{{ server_ip }}:8080/dashboard/"
          - "  - WireGuard UI: http://{{ server_ip }}/wireguard"
          - "    Default login: admin / admin (CHANGE THIS!)"
          - "  - Galène Video: http://{{ server_ip }}/galene"
          - "    Room: public (operator password: admin)"
          - ""
          - "Note: Using IP address. For HTTPS, configure DOMAIN_NAME."
          - "=============================================="
      when: not use_https
